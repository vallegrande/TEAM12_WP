{% extends "base.html" %}

{% block title %}Inicio - Carnicer√≠a Pochito{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/index.css') }}" rel="stylesheet">
<style>
#carritoModal {
  background-color: rgba(0, 0, 0, 0.6);
}
.modal-show {
  animation: fadeIn 0.3s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block content %}
<!-- SECCI√ìN PRINCIPAL -->
<section class="w-full max-w-6xl mx-auto mt-6 rounded-xl overflow-hidden shadow-2xl relative h-[450px]">
  <img src="{{ url_for('static', filename='image/fachada.jpg') }}" 
       alt="Fachada Carnicer√≠a Pochito" 
       class="w-full h-full object-cover absolute inset-0 filter brightness-[.45]">

  <div class="relative z-10 flex flex-col items-center justify-center h-full text-white text-center p-8">
      <h1 class="text-6xl sm:text-7xl font-extrabold tracking-tight mb-4 text-red-500 [text-shadow:_0_2px_4px_rgb(0_0_0_/_70%)]">
          POCHITO
      </h1>
      <p class="text-xl sm:text-2xl font-light mb-8">
          Los mejores cortes frescos, directo a tu mesa.
      </p>
      <a href="{{ url_for('productos') }}" 
         class="bg-red-600 text-white text-lg px-8 py-3 rounded-full font-bold shadow-xl 
                transition duration-300 transform hover:scale-105 hover:bg-red-700 
                focus:outline-none focus:ring-4 focus:ring-red-500 focus:ring-opacity-50">
          VER PRODUCTOS
      </a>
  </div>
</section>

<!-- BUSCADOR -->
<section class="mega-search-wrap">
  <div class="search-input">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="#9CA3AF" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="6" stroke="#9CA3AF" stroke-width="2"/></svg>
    <input id="global-search" type="search" placeholder="Buscar cortes, parrillas y todo para asar..." aria-label="Buscar productos" autocomplete="off">
    <button id="search-clear" title="Limpiar" style="background:none;border:none;cursor:pointer;color:#9CA3AF">‚úï</button>
  </div>
  <div class="search-chips" id="search-chips">
    <div class="chip" data-q="Costillas">Costillas</div>
    <div class="chip" data-q="Lomo">Lomo</div>
    <div class="chip" data-q="Aguja">Aguja</div>
    <div class="chip" data-q="Chorizo">Chorizo</div>
    <div class="chip" data-q="Parrilla">Parrilla</div>
  </div>

  <div id="mega-results" class="mega-results" role="region" aria-live="polite">
    <div class="mega-columns">
      <div class="mega-col">
        <h4>M√°s buscados</h4>
        <div id="most-searched"></div>
      </div>
      <div class="mega-col">
        <h4>Resultados</h4>
        <div id="search-products"></div>
      </div>
      <div class="mega-col">
        <h4>Categor√≠as</h4>
        <div id="search-categories">
          <div class="chip" data-cat="res">Res</div>
          <div class="chip" data-cat="cerdo">Cerdo</div>
          <div class="chip" data-cat="pollo">Pollo</div>
          <div class="chip" data-cat="ahumado">Ahumado</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SITE_PRODUCTS = [
      // Productos de res
      { img: "{{ url_for('static', filename='image/aguja.jpg') }}", nombre: "Aguja", precio: 25.50, tipo: "res" },
      { img: "{{ url_for('static', filename='image/bistec.jpg') }}", nombre: "Bistec", precio: 28.00, tipo: "res" },
      { img: "{{ url_for('static', filename='image/cadera.jpg') }}", nombre: "Cadera", precio: 23.00, tipo: "res" },
      { img: "{{ url_for('static', filename='image/costillas.jpg') }}", nombre: "Costillas", precio: 30.00, tipo: "res" },
      { img: "{{ url_for('static', filename='image/falda.jpg') }}", nombre: "Falda", precio: 22.50, tipo: "res" },
      { img: "{{ url_for('static', filename='image/lomo.jpg') }}", nombre: "Lomo", precio: 40.00, tipo: "res" },
      { img: "{{ url_for('static', filename='image/malaya.jpg') }}", nombre: "Malaya", precio: 24.50, tipo: "res" },
      { img: "{{ url_for('static', filename='image/pecho.jpg') }}", nombre: "Pecho", precio: 20.00, tipo: "res" },
      { img: "{{ url_for('static', filename='image/solomillo.jpg') }}", nombre: "Solomillo", precio: 45.00, tipo: "res" },
      
      // Productos de cerdo
      { img: "{{ url_for('static', filename='image/chuletas.jpg') }}", nombre: "Chuletas", precio: 25.50, tipo: "cerdo" },
      { img: "{{ url_for('static', filename='image/costillar.jpg') }}", nombre: "Costillar", precio: 30.00, tipo: "cerdo" },
      { img: "{{ url_for('static', filename='image/panceta.jpg') }}", nombre: "Panceta", precio: 28.00, tipo: "cerdo" },
      
      // Productos de pollo
      { img: "{{ url_for('static', filename='image/pechuga.jpg') }}", nombre: "Pechuga", precio: 15.00, tipo: "pollo" },
      { img: "{{ url_for('static', filename='image/muslo.jpg') }}", nombre: "Muslo", precio: 12.00, tipo: "pollo" },
      { img: "{{ url_for('static', filename='image/ala.jpg') }}", nombre: "Ala", precio: 10.50, tipo: "pollo" },

      // Productos de limpieza
      { img: "{{ url_for('static', filename='image/limpieza1.jpg') }}", nombre: "Limpiador de Parrilla", precio: 23.50, tipo: "limpieza" },
      { img: "{{ url_for('static', filename='image/limpieza2.jpg') }}", nombre: "Cepillo Limpiador", precio: 14.00, tipo: "limpieza" },
      { img: "{{ url_for('static', filename='image/limpieza3.jpg') }}", nombre: "Kit de Limpieza", precio: 26.00, tipo: "limpieza" },

      // Productos de encendido
      { img: "{{ url_for('static', filename='image/encendido1.jpg') }}", nombre: "Gel de encendido", precio: 9.50, tipo: "encendido" },
      { img: "{{ url_for('static', filename='image/encendido2.jpg') }}", nombre: "Cubos de encendido", precio: 14.00, tipo: "encendido" },
      { img: "{{ url_for('static', filename='image/encendido3.jpg') }}", nombre: "Combustible gel", precio: 18.00, tipo: "encendido" },
      { img: "{{ url_for('static', filename='image/encendido4.jpg') }}", nombre: "Trozos de toc√≥n", precio: 31.00, tipo: "encendido" },
      { img: "{{ url_for('static', filename='image/encendido5.jpg') }}", nombre: "Briquetas", precio: 22.50, tipo: "encendido" },

      // Parrillas y equipos
      { img: "{{ url_for('static', filename='image/parrilla1.jpg') }}", nombre: "Parrilla Carb√≥n", precio: 129.50, tipo: "parrilla" },
      { img: "{{ url_for('static', filename='image/parrilla2.jpg') }}", nombre: "Parrilla Gas", precio: 150.00, tipo: "parrilla" },
      { img: "{{ url_for('static', filename='image/parrilla3.jpg') }}", nombre: "Parrilla Port√°til", precio: 140.00, tipo: "parrilla" },
      { img: "{{ url_for('static', filename='image/parrilla4.jpg') }}", nombre: "Parrilla Carb√≥n Peque√±a", precio: 100.00, tipo: "parrilla" },
      { img: "{{ url_for('static', filename='image/parrilla5.jpg') }}", nombre: "Parrilla Gas Portable", precio: 120.00, tipo: "parrilla" },

      // Cuchillos y utensilios
      { img: "{{ url_for('static', filename='image/cuchillo1.jpg') }}", nombre: "Set de Cuchillos", precio: 25.50, tipo: "cuchillos" },
      { img: "{{ url_for('static', filename='image/cuchillo2.jpg') }}", nombre: "Cuchillo Chef", precio: 30.00, tipo: "cuchillos" },
      { img: "{{ url_for('static', filename='image/cuchillo3.jpg') }}", nombre: "Tenedor y Pinzas", precio: 28.00, tipo: "cuchillos" }
    ];
  </script>
</section>

<!-- PRODUCTOS -->
<section class="py-12 px-6">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
    <!-- SIDEBAR -->
    <aside class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
      <h3 class="font-semibold text-lg mb-4">FILTER BY</h3>
      <div class="mb-4">
        <input type="text" id="search-product" placeholder="Search product..." class="w-full border rounded px-3 py-2 text-sm">
      </div>

      <div class="mb-4">
        <h4 class="font-medium mb-2">Product Type</h4>
        <div class="space-y-2 text-sm text-gray-700">
          <label class="flex items-center"><input type="checkbox" class="mr-2 type-filter" value="res"> Beef (Res)</label>
          <label class="flex items-center"><input type="checkbox" class="mr-2 type-filter" value="cerdo"> Pork (Cerdo)</label>
          <label class="flex items-center"><input type="checkbox" class="mr-2 type-filter" value="pollo"> Poultry (Pollo)</label>
        </div>
      </div>

      <div class="mb-4">
        <h4 class="font-medium mb-2">Price</h4>
        <div class="flex items-center gap-2">
          <input id="price-min" type="number" placeholder="Min" class="w-1/2 border rounded px-2 py-1 text-sm">
          <input id="price-max" type="number" placeholder="Max" class="w-1/2 border rounded px-2 py-1 text-sm">
        </div>
        <div class="mt-3">
          <button id="apply-filters" class="bg-red-600 text-white px-4 py-2 rounded">Apply</button>
          <button id="reset-filters" class="ml-2 border px-3 py-2 rounded">Reset</button>
        </div>
      </div>
    </aside>

    <!-- PRODUCT GRID -->
    <div class="lg:col-span-3">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold">Nuestros Productos</h2>
        <div class="flex items-center gap-3">
          <label class="text-sm">Sort:</label>
          <select id="sort-home" class="border rounded px-3 py-2 text-sm">
            <option value="default">Default</option>
            <option value="precio-asc">Precio: menor a mayor</option>
            <option value="precio-desc">Precio: mayor a menor</option>
          </select>
        </div>
      </div>

      <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {% set productos = [
          ('aguja.jpg', 'Aguja', 25.50, 'res'),
          ('bistec.jpg', 'Bistec', 28.00, 'res'),
          ('cadera.jpg', 'Cadera', 23.00, 'res'),
          ('costillas.jpg', 'Costillas', 30.00, 'res'),
          ('falda.jpg', 'Falda', 22.50, 'res'),
          ('lomo.jpg', 'Lomo', 40.00, 'res'),
          ('malaya.jpg', 'Malaya', 24.50, 'res'),
          ('pecho.jpg', 'Pecho', 20.00, 'res'),
          ('solomillo.jpg', 'Solomillo', 45.00, 'res')
        ] %}
        {% for img, nombre, precio, tipo in productos %}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden product-card p-4 flex flex-col" data-precio="{{ precio }}" data-tipo="{{ tipo }}">
          <img src="{{ url_for('static', filename='image/' ~ img) }}" alt="{{ nombre }}" class="w-full h-44 object-cover rounded mb-3">
          <div class="flex-grow">
            <h3 class="text-lg font-semibold text-gray-800">{{ nombre }}</h3>
            <p class="text-red-600 font-bold text-xl mb-2">S/. {{ '%.2f'|format(precio) }}</p>
            <p class="text-sm text-gray-500 mb-3">Corte de calidad listo para cocinar.</p>
          </div>
          <div class="mt-2 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <input type="number" min="1" value="1" class="producto-cantidad w-16 text-center border rounded" />
              <button class="agregar-carrito bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" 
                      data-id="{{ nombre|lower|replace(' ', '_') }}" data-nombre="{{ nombre }}" data-precio="{{ precio }}" data-imagen="{{ url_for('static', filename='image/' ~ img) }}">
                ADD TO CART
              </button>
            </div>
            <button class="text-sm text-gray-500">READ MORE</button>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- PAGINACI√ìN -->
      <div class="mt-8 flex justify-center">
        <nav class="inline-flex -space-x-px">
          <a class="px-3 py-2 border rounded-l" href="#">Previous</a>
          <a class="px-3 py-2 border" href="#">1</a>
          <a class="px-3 py-2 border" href="#">2</a>
          <a class="px-3 py-2 border rounded-r" href="#">Next</a>
        </nav>
      </div>
    </div>
  </div>
</section>

<!-- MODAL DEL CARRITO -->
<div id="carritoModal" class="hidden fixed inset-0 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl w-[90%] max-w-lg p-6 modal-show relative">
    <button id="cerrarCarrito" class="absolute top-3 right-3 text-gray-500 hover:text-red-600 text-2xl font-bold">
      &times;
    </button>
    <h2 class="text-2xl font-bold text-gray-800 mb-4">üõí Tu Carrito</h2>
    <div id="carritoItems" class="max-h-60 overflow-y-auto text-gray-700 mb-4">
      <p class="text-gray-500 text-center">Tu carrito est√° vac√≠o.</p>
    </div>
    <div class="flex justify-between items-center">
      <span class="font-semibold text-lg">Total:</span>
      <span id="carritoTotal" class="font-bold text-red-600 text-xl">S/ 0.00</span>
    </div>
    <div class="flex justify-end mt-4">
      <button id="vaciarCarrito" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg mr-2 hover:bg-gray-400">Vaciar</button>
      <button id="finalizarCompra" class="bg-red-600 text-white px-5 py-2 rounded-lg hover:bg-red-700 transition">Finalizar compra</button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/buscador.js') }}"></script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modal = document.getElementById('carritoModal');
  const cerrar = document.getElementById('cerrarCarrito');
  const itemsEl = document.getElementById('carritoItems');
  const totalEl = document.getElementById('carritoTotal');
  const vaciar = document.getElementById('vaciarCarrito');
  const finalizar = document.getElementById('finalizarCompra');

  function renderModalCart() {
    const items = (window.carrito && window.carrito.items) ? window.carrito.items : (JSON.parse(localStorage.getItem('carrito')) || []);
    if (!items || items.length === 0) {
      itemsEl.innerHTML = '<p class="text-gray-500 text-center">Tu carrito est√° vac√≠o.</p>';
      totalEl.textContent = 'S/ 0.00';
      return;
    }

    let html = '';
    let total = 0;

    items.forEach(p => {
      const subtotal = (p.precio || 0) * (p.cantidad || 0);
      total += subtotal;
      const idAttr = p.id || p.nombre || '';
      const img = p.imagen ? `<img src="${p.imagen}" class="w-12 h-12 object-cover rounded mr-2">` : '';
      html += `
        <div class="flex justify-between items-center border-b py-2">
          <div class="flex items-center">
            ${img}
            <div>
              <span class="font-medium">${p.nombre}</span>
              <span class="text-sm text-gray-500 ml-2">(x${p.cantidad})</span>
            </div>
          </div>
          <div class="flex items-center">
            <span class="text-red-600 font-semibold">S/ ${subtotal.toFixed(2)}</span>
            <button class="remove-item ml-3 text-red-500 hover:text-red-700" data-id="${idAttr}" aria-label="Eliminar">‚úï</button>
          </div>
        </div>
      `;
    });

    itemsEl.innerHTML = html;
    totalEl.textContent = `S/ ${total.toFixed(2)}`;

    // attach remove handlers
    itemsEl.querySelectorAll('.remove-item').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = btn.dataset.id;
        if (window.carrito && typeof window.carrito.eliminarProducto === 'function') {
          window.carrito.eliminarProducto(id);
          renderModalCart();
        } else {
          // fallback: update localStorage
          let arr = JSON.parse(localStorage.getItem('carrito')) || [];
          arr = arr.filter(it => ((it.id || it.nombre) !== id));
          localStorage.setItem('carrito', JSON.stringify(arr));
          renderModalCart();
        }
      });
    });
  }

  // Open modal and re-render when an 'agregar-carrito' button is clicked (small delay to allow other handlers to run)
  document.querySelectorAll('.agregar-carrito').forEach(boton => {
    boton.addEventListener('click', () => {
      setTimeout(() => {
        renderModalCart();
        if (modal) modal.classList.remove('hidden');
      }, 120);
    });
  });

  cerrar.addEventListener('click', () => modal.classList.add('hidden'));

  vaciar.addEventListener('click', () => {
    if (window.carrito) {
      window.carrito.items = [];
      window.carrito.guardarCarrito();
      if (typeof window.carrito.actualizarCarritoLateral === 'function') window.carrito.actualizarCarritoLateral();
    } else {
      localStorage.setItem('carrito', JSON.stringify([]));
    }
    renderModalCart();
  });

  if (finalizar) {
    finalizar.addEventListener('click', () => {
      const items = (window.carrito && window.carrito.items) ? window.carrito.items : (JSON.parse(localStorage.getItem('carrito')) || []);
      if (items.length === 0) {
        alert('El carrito est√° vac√≠o. Agrega productos antes de finalizar.');
        return;
      }
      // Redirigir a la p√°gina de carrito detallado / proceso de pago
      window.location.href = '/carrito';
    });
  }

  // initial render
  renderModalCart();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elementos
  const contenedor = document.getElementById('products-grid');
  const selectOrden = document.getElementById('sort-home');
  const searchSidebar = document.getElementById('search-product');
  const typeCheckboxes = Array.from(document.querySelectorAll('.type-filter'));
  const priceMin = document.getElementById('price-min');
  const priceMax = document.getElementById('price-max');
  const btnApply = document.getElementById('apply-filters');
  const btnReset = document.getElementById('reset-filters');

  if (!contenedor) {
    console.warn('No se encontr√≥ #products-grid en la p√°gina.');
    return;
  }

  // Tomamos las tarjetas (nodes) y guardamos el orden original
  const tarjetasNodeList = Array.from(contenedor.querySelectorAll('.product-card'));
  const originalOrder = tarjetasNodeList.slice(); // copia para reset

  // Funci√≥n que convierte data-precio en n√∫mero seguro
  function precioDe(card) {
    const val = card.dataset.precio;
    const n = parseFloat(String(val).replace(',', '.'));
    return Number.isFinite(n) ? n : 0;
  }

  // Aplica filtros combinados: b√∫squeda, tipos y rango de precio
  function aplicarFiltrosYOrden() {
    // 1) obtener criterios
    const query = (searchSidebar?.value || '').trim().toLowerCase();
    const tiposSeleccionados = typeCheckboxes.filter(c => c.checked).map(c => c.value);
    const min = priceMin?.value ? parseFloat(priceMin.value) : null;
    const max = priceMax?.value ? parseFloat(priceMax.value) : null;
    const orden = selectOrden?.value || 'default';

    // 2) filtrar sobre el array original (para preservar orden base)
    let visibles = originalOrder.filter(card => {
      // filtro por nombre (t√≠tulo h3)
      const nombreEl = card.querySelector('h3');
      const nombre = nombreEl ? nombreEl.textContent.trim().toLowerCase() : '';
      if (query && !nombre.includes(query)) return false;

      // filtro por tipo (data-tipo)
      const tipo = (card.dataset.tipo || '').toLowerCase();
      if (tiposSeleccionados.length > 0 && !tiposSeleccionados.includes(tipo)) return false;

      // filtro por precio
      const p = precioDe(card);
      if (min !== null && p < min) return false;
      if (max !== null && p > max) return false;

      return true;
    });

    // 3) ordenar seg√∫n selecci√≥n
    if (orden === 'precio-asc') {
      visibles.sort((a, b) => precioDe(a) - precioDe(b));
    } else if (orden === 'precio-desc') {
      visibles.sort((a, b) => precioDe(b) - precioDe(a));
    } // default deja el orden del originalOrder (ya preservado)

    // 4) renderizar: limpiar contenedor y volver a insertar visibles
    contenedor.innerHTML = '';
    if (visibles.length === 0) {
      contenedor.innerHTML = '<div class="col-span-3 text-center text-gray-500 p-6">No hay productos que coincidan con los filtros.</div>';
      return;
    }
    visibles.forEach(card => contenedor.appendChild(card));
  }

  // 5) Handlers
  // orden
  if (selectOrden) {
    selectOrden.addEventListener('change', () => aplicarFiltrosYOrden());
  }

  // b√∫squeda en sidebar (con debounce)
  let debounceTimer;
  if (searchSidebar) {
    searchSidebar.addEventListener('input', e => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => aplicarFiltrosYOrden(), 200);
    });
  }

  // checkboxes de tipos
  typeCheckboxes.forEach(cb => cb.addEventListener('change', aplicarFiltrosYOrden));

  // rango de precio y botones
  if (btnApply) btnApply.addEventListener('click', aplicarFiltrosYOrden);

  if (btnReset) {
    btnReset.addEventListener('click', () => {
      // limpiar controles
      if (searchSidebar) searchSidebar.value = '';
      typeCheckboxes.forEach(c => c.checked = false);
      if (priceMin) priceMin.value = '';
      if (priceMax) priceMax.value = '';
      if (selectOrden) selectOrden.value = 'default';
      // restaurar orden original
      contenedor.innerHTML = '';
      originalOrder.forEach(card => contenedor.appendChild(card));
    });
  }

  // ejecutar al inicio para aplicar estado actual (por si alg√∫n control ya viene con valor)
  aplicarFiltrosYOrden();

  // DEBUG: si no funciona, abre la consola y busca logs
  console.debug('Filtro y orden inicializados. N√∫mero total productos:', originalOrder.length);
});
</script>

{% endblock %}
